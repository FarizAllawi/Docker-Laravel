# Redis configuration file for production AI Screening Service

#------------------------------------------------------------------------------
# NETWORK
#------------------------------------------------------------------------------

# Bind to all interfaces, but consider restricting in production
bind 0.0.0.0

# Protected mode - disable if you have proper network security
protected-mode no

# Port to listen on
port 6379

# TCP listen() backlog
tcp-backlog 511

# Unix socket (optional)
# unixsocket /var/run/redis/redis.sock
# unixsocketperm 700

# Close the connection after a client is idle for N seconds (0 to disable)
timeout 0

# TCP keepalive
tcp-keepalive 300

#------------------------------------------------------------------------------
# GENERAL
#------------------------------------------------------------------------------

# Run as daemon (Docker handles this)
daemonize no

# PID file (Docker handles this)
# pidfile /var/run/redis_6379.pid

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (Docker handles this)
# logfile ""

# Database count
databases 16

# Show logo on startup
always-show-logo no

# Set the number of databases
databases 16

#------------------------------------------------------------------------------
# SNAPSHOTTING (RDB PERSISTENCE)
#------------------------------------------------------------------------------

# Save the DB to disk
save 900 1      # 15 minutes if at least 1 key changed
save 300 10     # 5 minutes if at least 10 keys changed
save 60 10000   # 1 minute if at least 10000 keys changed

# Stop writes on error
stop-writes-on-bgsave-error yes

# Compress string objects in RDB
rdbcompression yes

# RDB checksum
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# RDB directory
dir /data

#------------------------------------------------------------------------------
# REPLICATION
#------------------------------------------------------------------------------

# Master-Replica replication (comment out for single instance)
# replicaof <masterip> <masterport>

# Master password
# masterauth <master-password>

# When a replica loses its connection with the master, or when the replication
# is still in progress, the replica can act in two different ways:
replica-serve-stale-data yes

# Replicas send REPLCONF ACK to masters
replica-read-only yes

# Diskless replication
repl-diskless-sync no

# Delay for next diskless replication
repl-diskless-sync-delay 5

# Replica priority for failover
replica-priority 100

#------------------------------------------------------------------------------
# SECURITY
#------------------------------------------------------------------------------

# Require clients to issue AUTH <PASSWORD>
# requirepass YourSecureRedisPassword123!

# Rename dangerous commands for security
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""

# Command renaming example (uncomment to enable)
# rename-command KEYS ""

#------------------------------------------------------------------------------
# CLIENTS
#------------------------------------------------------------------------------

# Set the max number of connected clients at the same time
maxclients 10000

#------------------------------------------------------------------------------
# MEMORY MANAGEMENT
#------------------------------------------------------------------------------

# Set a memory usage limit
maxmemory 1gb

# Maxmemory policy: how Redis will select what to remove when maxmemory is reached
maxmemory-policy allkeys-lru

# LRU, LFU and minimal TTL algorithms are not precise but approximated
maxmemory-samples 5

# Don't use more memory than needed for thread stacks
# This is more relevant for systems with many clients
# client-query-buffer-limit 1gb

#------------------------------------------------------------------------------
# APPEND ONLY MODE (AOF PERSISTENCE)
#------------------------------------------------------------------------------

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# fsync() calls
appendfsync everysec

# When AOF fsync policy is set to always or everysec, and a background saving
# process is performing a lot of I/O against the disk, Redis may block too long
no-appendfsync-on-rewrite no

# Automatic rewrite percentage
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load AOF if truncated
aof-load-truncated yes

# AOF file rewrite strategy
aof-rewrite-incremental-fsync yes

#------------------------------------------------------------------------------
# LUA SCRIPTING
#------------------------------------------------------------------------------

# Max execution time of a Lua script in milliseconds
lua-time-limit 5000

#------------------------------------------------------------------------------
# REDIS CLUSTER
#------------------------------------------------------------------------------

# Normal Redis instances can't be part of a Redis Cluster
cluster-enabled no

# Cluster configuration file
# cluster-config-file nodes-6379.conf

# Node timeout
# cluster-node-timeout 15000

#------------------------------------------------------------------------------
# SLOW LOG
#------------------------------------------------------------------------------

# The Slow Log is a system to log queries that exceeded a specified execution time
slowlog-log-slower-than 10000  # 10 milliseconds
slowlog-max-len 128

#------------------------------------------------------------------------------
# LATENCY MONITOR
#------------------------------------------------------------------------------

# The latency monitoring subsystem samples different operations at runtime
latency-monitor-threshold 0  # 0 to disable, or set threshold in milliseconds

#------------------------------------------------------------------------------
# EVENT NOTIFICATION
#------------------------------------------------------------------------------

# Redis can notify Pub/Sub clients about events happening in the key space
notify-keyspace-events ""

#------------------------------------------------------------------------------
# ADVANCED CONFIG
#------------------------------------------------------------------------------

# Hash configuration
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List configuration
list-max-ziplist-size -2
list-compress-depth 0

# Set configuration
set-max-intset-entries 512

# Sorted set configuration
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog configuration
hll-sparse-max-bytes 3000

# Stream configuration
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Hz: Redis calls an internal function to perform many background tasks
hz 10

# Dynamic Hz
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

#------------------------------------------------------------------------------
# ACTIVE DEFRAGMENTATION
#------------------------------------------------------------------------------

# Enabled active defragmentation
activedefrag yes

# Minimum amount of fragmentation waste to start active defrag
active-defrag-ignore-bytes 100mb

# Minimum percentage of fragmentation to start active defrag
active-defrag-threshold-lower 10

# Maximum percentage of fragmentation at which we use maximum effort
active-defrag-threshold-upper 100

# Minimal effort for defrag in CPU percentage
active-defrag-cycle-min 25

# Maximal effort for defrag in CPU percentage
active-defrag-cycle-max 75
